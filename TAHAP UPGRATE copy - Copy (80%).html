<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Bengkel Trisno Motor</title>
<style>
  :root{--sidebar-w:250px;--accent:#ffcc00}
  *{box-sizing:border-box}
  body,html{margin:0;height:100%;font-family:Arial,system-ui,sans-serif;background-color:rgb(54, 141, 141)}
  /* Optional: background image - place the file next to the HTML or change path */
  body {
    background-image: url('45e3db6e-84c9-464f-a51d-ab65e611e712.png');
    background-size: cover;
    background-position: center;
    background-attachment: fixed;
  }

  /* Sidebar */
  .sidebar {
    position:fixed;
    left:0; top:0;
    width:var(--sidebar-w);
    height:100%;
    background:rgba(10,10,10,0.9);
    color:#fff;
    display:flex;
    flex-direction:column;
    padding:12px 8px;
    gap:6px;
    transition:width .25s ease;
    z-index:1000;
  }
  .brand{display:flex;align-items:center;gap:8px;padding:8px 10px}
  .brand h1{font-size:18px;margin:0;color:var(--accent)}
  .nav {
    display: flex;
    flex-direction: column;
    flex-grow: 1; /* Makes the navigation section flexible */
  }
  .nav a{display:block;padding:10px;border-radius:6px;color:#fff;text-decoration:none;margin:4px 6px;}
  .nav a:hover{background:rgba(255,255,255,0.06)}
  .logout-btn-nav{
    display: block;
    padding: 10px;
    border-radius: 6px;
    color: #fff;
    text-decoration: none;
    margin: auto 6px 4px; /* Push to the bottom */
    background: #b71c1c;
    cursor: pointer;
    font-weight: 700;
    text-align: center;
  }
  .logout-btn-nav:hover{
    background:#d32f2f;
  }

  /* Hamburger for small screens */
  .hamburger {
    display:none;
    position:fixed;
    left:10px;
    top:10px;
    background:rgba(0,0,0,0.7);
    color:#fff;
    border:0;
    padding:10px 12px;
    font-size:20px;
    border-radius:6px;
    z-index:1100;
  }

  /* Main content area */
  .main {
    margin-left:var(--sidebar-w);
    padding:20px;
    min-height:100vh;
    transition:margin-left .25s ease;
    background: rgba(255,255,255,0.85);
    position: relative; /* Needed for positioning the profile icon */
  }

  /* Cards / sections */
  .card {background:white;border-radius:8px;padding:12px;margin-bottom:14px;box-shadow:0 2px 6px rgba(0,0,0,0.08)}
  label{display:block;margin:6px 0;font-weight:600;color:#111}
  input[type="text"], input[type="number"], select, .searchable-select {
    width:100%;padding:8px;border-radius:6px;border:1px solid #ccc;margin-top:6px;
  }
  button {
    background:linear-gradient(180deg,var(--accent),#e6b800);
    border:0;padding:8px 12px;border-radius:6px;cursor:pointer;font-weight:700;
  }
  button.ghost{background:transparent;border:1px solid #ccc;color:#333}

  /* Tables */
  .table-wrap{overflow:auto}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border:1px solid #ddd;text-align:left}
  th{background:#fafafa}

  /* Modal */
  .modal {
    position: fixed;
    z-index: 1;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.4);
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .modal-content {
    background-color: #fefefe;
    padding: 20px;
    border: 1px solid #888;
    width: 90%;
    max-width: 600px;
    border-radius: 8px;
  }
  .close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
  }
  .close:hover,
  .close:focus {
    color: black;
    text-decoration: none;
    cursor: pointer;
  }
  .modal-body-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
  }
  .modal-body-table th, .modal-body-table td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: left;
  }
  
  /* Searchable select for transaksi */
  .searchable-select {
    position: relative;
  }
  .searchable-select input {
    width: 100%;
    padding: 8px;
    border-radius: 6px;
    border: 1px solid #ccc;
    margin-top: 6px;
  }
  .search-results {
    position: absolute;
    z-index: 99;
    width: 100%;
    max-height: 200px;
    overflow-y: auto;
    background: #fff;
    border: 1px solid #ccc;
    border-top: none;
    border-radius: 0 0 6px 6-6px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }
  .search-results div {
    padding: 8px;
    cursor: pointer;
  }
  .search-results div:hover {
    background-color: #f0f0f0;
  }

  /* Small screens */
  @media (max-width:800px){
    .sidebar{width:0;overflow:hidden}
    .main{margin-left:0;padding:12px}
    .hamburger{display:block}
  }

  /* Login page styles */
  #loginPage{
    position:fixed;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    background: linear-gradient(135deg, #4299e1, #a739d8, #d8396e);
  }
  #loginBox {
    width: 360px;
    max-width: 95%;
    background: white;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    text-align: center;
    color: #333;
  }
  #loginBox h2 {
    margin-top: 0;
    margin-bottom: 20px;
    font-size: 24px;
    color: #1a202c;
  }
  .login-input-group {
    position: relative;
    margin-bottom: 20px;
  }
  .login-input-group svg {
    position: absolute;
    left: 10px;
    top: 50%;
    transform: translateY(-50%);
    color: #718096;
  }
  #loginBox input {
    border: none;
    border-bottom: 1px solid #e2e8f0;
    padding: 10px 10px 10px 35px;
    width: 100%;
    outline: none;
    font-size: 16px;
    transition: border-bottom-color 0.3s;
    background-color: #ffff;
  }
  #loginBox input:focus {
    border-bottom-color: #4299e1;
  }
  .forgot-password {
    display: block;
    text-align: right;
    font-size: 12px;
    color: #4299e1;
    text-decoration: none;
    margin-top: -10px;
    margin-bottom: 20px;
  }
  #loginBox button {
    width: 100%;
    background: linear-gradient(90deg, #4299e1, #a739d8, #d8396e);
    color: white;
    padding: 12px;
    border: none;
    border-radius: 25px;
    font-size: 18px;
    cursor: pointer;
    transition: opacity 0.3s;
    font-weight: 600;
  }
  #loginBox button:hover {
    opacity: 0.9;
  }
  .small-muted {
    font-size: 13px;
    color: #666;
    margin-top: 20px;
    line-height: 1.5;
  }
  
  .password-toggle-icon {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    cursor: pointer;
    color: #718096;
  }
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginPage">
  <div id="loginBox">
    <h2>Login</h2>
    <div class="login-input-group">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
      <input id="loginUsername" type="text" placeholder="Type your username">
    </div>
    <div class="login-input-group">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-lock"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
      <input id="loginPassword" type="password" placeholder="Type your password">
      <span class="password-toggle-icon" onclick="togglePasswordVisibility('loginPassword')">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-eye"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>
      </span>
    </div>
    <a href="#" class="forgot-password" onclick="showForgotPasswordModal()">Forgot password?</a>
    <button onclick="doLogin()">Login</button>
    <div class="small-muted">Selamat datang 
      silahkan masukan username dan password anda dengan benar
       jika terjadi kesalahan silahkan hubungi email dibawah ini 
      <b>risqullahariffikri@gmail.com</b>
      </div>
  </div>
</div>

<!-- SIDEBAR -->
<button class="hamburger" onclick="toggleSidebar()">‚ò∞</button>

<div class="sidebar" id="sidebar" style="display:none;">
  <div>
    <div class="brand"><img src="" alt="" style="width:36px;height:36px;border-radius:6px;display:none"><h1>Bengkel Trisno Motorüõ†Ô∏è</h1>
    </div>
    <nav class="nav">
      <a href="#" onclick="showSection('stok')">üì¶ Stok Barang</a>
      <a href="#" onclick="showSection('transaksi')">üí≥ Transaksi</a>
      <a href="#" onclick="showSection('keranjang')">üßæ Keranjang</a>
      <a href="#" onclick="showSection('riwayat')">üìú Riwayat</a>
      <a href="#" class="logout-btn-nav" onclick="showLogoutModal()">üö™ Logout</a>
    </nav>
  </div>
</div>

<!-- MAIN -->
<div class="main" id="appMain" style="display:none">
  <!-- Stok -->
  <section id="section-stok" class="card" style="display:none">
    <h2 style="margin-top:0;color:#222;font-weight:800">Stok Barang</h2>

    <div style="margin-top:12px">
      <h3 style="margin-bottom:6px">Tambah / Update Barang</h3>
      <label>Nama Barang:</label>
      <input id="inNama" type="text" placeholder="masukan Nama Barang">
      <label>Harga Satuan (Rp):</label>
      <input id="inHarga" type="number" placeholder="masukan Harga Satuan">
      <label>Stok Terbaru:</label>
      <input id="inStok" type="number" placeholder="masukan stok terbaru">
      <div style="display:flex;gap:8px;margin-top:8px">
        <button onclick="tambahAtauUpdate()">Tambah / Update</button>
        <button class="ghost" onclick="clearInputs()">Reset</button>
      </div>
      
      <hr style="border:0; border-top: 1px solid #ccc;margin: 20px 0;">

      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px; margin: top 20px;">
      <input id="stokSearch" type="text" placeholder="Cari item" oninput="renderStokTable()" style="flex:1">
      <button onclick="renderStokTable()" class="ghost">Cari</button>
      <select id="stokSort" onchange="renderStokTable()">
      <option value="asc">(A-Z)</option>
      <option value="desc">(Z-A)</option>
     </select>
      
    </div>
    <div class="table-wrap card">
      <table id="stokTable">
        <thead><tr><th>No</th><th>Nama Barang</th><th>Harga Barang</th><th>Stok</th><th>Aksi</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    </div>
  </section>

  <!-- Transaksi -->
  <section id="section-transaksi" class="card" style="display:none">
    <h2 style="margin-top:0;color:#222;font-weight:800">Transaksi</h2>
    <label>Nama Pelanggan:</label>
    <input id="transaksipelanggan" type="text" placeholder="Nama Pelanggan">
    <label>Nama Barang:</label>
    <div class="searchable-select">
      <input id="transaksiSearchInput" type="text" placeholder="Cari barang...">
      <div id="transaksiSearchResults" class="search-results" style="display:none;"></div>
      <input type="hidden" id="transaksiSelectedItemIndex">
    </div>
    <label>Jumlah Beli:</label>
    <input id="transaksiJumlah" type="number" value="1">
    <div style="margin-top:8px">
      <button onclick="tambahItemKeKeranjang()">Tambahkan ke Keranjang</button>
    </div>
  </section>

  <!-- Keranjang -->
   <section id="section-keranjang" class="card" style="display:none">
    <h2 style="margin-top:0;color:#222;font-weight:800">Keranjang</h2>
    <div class="table-wrap card">
      <table id="keranjangTable">
        <thead><tr><th>Nama Barang</th><th>Jumlah</th><th>Harga satuan</th><th>Subtotal</th><th>Aksi</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
      <div style="flex:1;min-width:180px">
        <label>Diskon (%):</label>
        <input id="inputDiskon" type="number" value="0" min="0" max="100" oninput="hitungRingkasan()">
      </div>
      <div style="flex:1;min-width:180px">
        <label>Metode Pembayaran:</label>
        <select id="metodePembayaran" onchange="hitungRingkasan()">
          <option value="Cash">Cash</option>
          <option value="Debit">Debit</option>
        </select>
      </div>
      <div style="flex:1;min-width:180px">
        <label>Bayar (Rp):</label>
        <input id="inputBayar" type="number" value="0" oninput="hitungRingkasan()">
      </div>
      <div style="flex:1;min-width:180px">
        <label>Total (Rp):</label>
        <div id="textTotal" style="font-weight:800;padding:8px 6px;background:#f7f7f7;border-radius:6px">0</div>
      </div>
      <div style="flex:1;min-width:180px">
        <label>Kembalian (Rp):</label>
        <div id="textKembali" style="font-weight:800;padding:8px 6px;background:#f7f7f7;border-radius:6px">0</div>
      </div>
    </div>
    <div style="margin-top:10px;display:flex;gap:8px">
      <button onclick="cetakStruk()">Cetak Struk</button>
      <button class="ghost" onclick="kosongkanKeranjang()">Kosongkan Keranjang</button>
    </div>
  </section>

  <!-- Riwayat -->
  <section id="section-riwayat" class="card" style="display:none">
    <h2 style="margin-top:0;color:#222;font-weight:800">Riwayat Transaksi</h2>
    <div class="table-wrap card">
      <table id="riwayatTable">
        <thead><tr><th>Waktu</th><th>Pelanggan</th><th>Total</th><th>Metode</th><th>Aksi</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

</div>

<!-- Modal untuk konfirmasi Logout -->
<div id="logoutModal" class="modal" style="display:none;">
    <div class="modal-content">
        <h3 style="margin-top:0;">Konfirmasi Keluar</h3>
        <p>Anda yakin ingin keluar?</p>
        <div style="display:flex; gap: 10px; justify-content: flex-end;">
            <button class="ghost" onclick="closeLogoutModal()">Tidak</button>
            <button onclick="logout()">Ya</button>
        </div>
    </div>
</div>

<!-- Modal untuk detail Riwayat -->
<div id="riwayatModal" class="modal" style="display:none;">
  <div class="modal-content">
    <span class="close" onclick="closeRiwayatModal()">&times;</span>
    <h3 style="margin-top:0;">Detail Transaksi</h3>
    <p><b>Nama Pelanggan:</b> <span id="modalPelanggan"></span></p>
    <p><b>Tanggal:</b> <span id="modalTanggal"></span></p>
    <p><b>Metode Pembayaran:</b> <span id="modalMetode"></span></p>
    <table class="modal-body-table">
      <thead>
        <tr>
          <th>Nama Barang</th>
          <th>Jumlah</th>
          <th>Harga Satuan</th>
          <th>Subtotal</th>
        </tr>
      </thead>
      <tbody id="modalBarangTableBody">
      </tbody>
    </table>
    <div style="text-align:right; margin-top:10px;"><b>Total:</b> Rp <span id="modalTotal"></span></div>
  </div>
</div>

<!-- Modal untuk pemulihan password -->
<div id="forgotPasswordModal" class="modal" style="display:none;">
  <div class="modal-content">
    <span class="close" onclick="closeForgotPasswordModal()">&times;</span>
    <h3 style="margin-top:0;">Pemulihan Password</h3>
    <div class="login-input-group">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
      <input id="forgotUsername" type="text" placeholder="Username">
    </div>
    <div class="login-input-group">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-lock"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
      <input id="forgotOldPassword" type="password" placeholder="Password lama">
      <span class="password-toggle-icon" onclick="togglePasswordVisibility('forgotOldPassword')">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-eye"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>
      </span>
    </div>
    <div class="login-input-group">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-lock"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
      <input id="forgotNewPassword" type="password" placeholder="Password baru">
      <span class="password-toggle-icon" onclick="togglePasswordVisibility('forgotNewPassword')">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-eye"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>
      </span>
    </div>
    <div style="display:flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
        <button class="ghost" onclick="closeForgotPasswordModal()">Batal</button>
        <button onclick="recoverPassword()">Pulihkan</button>
    </div>
  </div>
</div>


<script>
/* ===== Utilities & state ===== */
const STORAGE_STOK = 'bengkel_stok_v1';
const STORAGE_KERANJANG = 'bengkel_keranjang_v1';
const STORAGE_RIWAYAT = 'bengkel_riwayat_v1';
const STORAGE_LOGIN = 'bengkel_logged_v1';

let stok = JSON.parse(localStorage.getItem(STORAGE_STOK) || '[]');
let keranjang = JSON.parse(localStorage.getItem(STORAGE_KERANJANG) || '[]');
let riwayat = JSON.parse(localStorage.getItem(STORAGE_RIWAYAT) || '[]');

/* ===== Login handling ===== */
function doLogin(){
  const user = document.getElementById('loginUsername').value;
  const pass = document.getElementById('loginPassword').value;
  // username dan password bisa diubah
  if(user === 'admin' && pass === 'bengkel123') {
    localStorage.setItem(STORAGE_LOGIN, '1');
    document.getElementById('loginPage').style.display = 'none';
    document.getElementById('appMain').style.display = 'block';
    // Show sidebar and main content after login
    document.getElementById('sidebar').style.display = 'flex';
    initAfterLogin();
  } else {
    alert('Username atau Password salah');
  }
}

function showLogoutModal() {
    document.getElementById('logoutModal').style.display = 'flex';
}

function closeLogoutModal() {
    document.getElementById('logoutModal').style.display = 'none';
}

function showForgotPasswordModal() {
    document.getElementById('forgotPasswordModal').style.display = 'flex';
}

function closeForgotPasswordModal() {
    document.getElementById('forgotPasswordModal').style.display = 'none';
}

function recoverPassword() {
  const user = document.getElementById('forgotUsername').value;
  const oldPass = document.getElementById('forgotOldPassword').value;
  const newPass = document.getElementById('forgotNewPassword').value;

  if (user === 'admin' && oldPass === 'bengkel123') {
    // Di sini Anda dapat menambahkan logika untuk menyimpan kata sandi baru.
    // Untuk saat ini, kita hanya akan menampilkan pesan sukses.
    alert('Password berhasil diubah. Password baru: ' + newPass);
    closeForgotPasswordModal();
  } else {
    alert('Username atau password lama salah.');
  }
}

function togglePasswordVisibility(inputId) {
    const passwordInput = document.getElementById(inputId);
    const toggleIcon = passwordInput.nextElementSibling;
    if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        toggleIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-eye-off"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/><path d="M6.61 6.61A13.52 13.52 0 0 0 2 12s3 7 10 7a9.75 9.75 0 0 0 5.39-1.61"/><line x1="2" x2="22" y1="2" y2="22"/></svg>`;
    } else {
        passwordInput.type = 'password';
        toggleIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-eye"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>`;
    }
}

function logout(){
  localStorage.removeItem(STORAGE_LOGIN);
  // Hide sidebar and main content before returning to login page
  document.getElementById('sidebar').style.display = 'none';
  document.getElementById('appMain').style.display = 'none';
  location.reload();
}

/* If already logged in, show app and sidebar */
if(localStorage.getItem(STORAGE_LOGIN)) {
  document.getElementById('loginPage').style.display = 'none';
  document.getElementById('appMain').style.display = 'block';
  document.getElementById('sidebar').style.display = 'flex';
  initAfterLogin();
}

/* ===== UI toggles ===== */
function toggleSidebar(){
  const sb = document.getElementById('sidebar');
  if(sb.style.width && sb.style.width !== '') {
    sb.style.width = (sb.style.width === '0px' || sb.style.width === '0') ? getComputedStyle(document.documentElement).getPropertyValue('--sidebar-w') || '250px' : '0';
  } else {
    sb.style.width = (window.innerWidth <= 800) ? '0' : '250px';
  }
}

/* ===== Initialize app after login ===== */
function initAfterLogin(){
  bindNav();
  showSection('stok');
  renderStokTable();
  setupTransaksiSearch();
  renderKeranjangTable();
  renderRiwayatTable();
}

/* ===== Navigation ===== */
function bindNav(){
  // nothing heavy needed; actions call showSection directly
}
function showSection(key){
  document.querySelectorAll('#appMain section.card').forEach(s=>s.style.display='none');
  if(key === 'stok') document.getElementById('section-stok').style.display='block';
  if(key === 'transaksi') document.getElementById('section-transaksi').style.display='block';
  if(key === 'keranjang') document.getElementById('section-keranjang').style.display='block';
  if(key === 'riwayat') document.getElementById('section-riwayat').style.display='block';
  // update views
  renderStokTable();
  setupTransaksiSearch();
  renderKeranjangTable();
  renderRiwayatTable();
}

/* ===== Stok functionality ===== */
function saveStok(){ localStorage.setItem(STORAGE_STOK, JSON.stringify(stok)); }
function saveKeranjang(){ localStorage.setItem(STORAGE_KERANJANG, JSON.stringify(keranjang)); }
function saveRiwayat(){ localStorage.setItem(STORAGE_RIWAYAT, JSON.stringify(riwayat)); }

function tambahAtauUpdate(){ tambahBaru(); } // Bind old button to new function

function clearInputs(){
  document.getElementById('inNama').value = '';
  document.getElementById('inHarga').value = '';
  document.getElementById('inStok').value = '';
}

function tambahBaru(){
  const n = document.getElementById('inNama').value.trim();
  const h = parseFloat(document.getElementById('inHarga').value) || 0;
  const s = parseInt(document.getElementById('inStok').value) || 0;
  if(!n){ alert('Isi nama barang'); return; }
  // if exists, update stok + harga
  const idx = stok.findIndex(x => x.nama.toLowerCase() === n.toLowerCase());
  if(idx >= 0){
    // update existing
    stok[idx].harga = h || stok[idx].harga;
    stok[idx].stok = (stok[idx].stok || 0) + s;
  } else {
    stok.push({ nama: n, harga: h, stok: s });
  }
  saveStok();
  renderStokTable();
  setupTransaksiSearch();
  clearInputs();
}

function renderStokTable(){
  const tbody = document.querySelector('#stokTable tbody');
  const q = (document.getElementById('stokSearch')?.value || '').toLowerCase();
  const sortOrder = document.getElementById('stokSort')?.value || 'asc';
  tbody.innerHTML = '';
  
  let filteredStok = stok.filter(it => !q || it.nama.toLowerCase().includes(q));

  // Sort logic based on selected value
  filteredStok.sort((a, b) => {
    const nameA = a.nama.toLowerCase();
    const nameB = b.nama.toLowerCase();
    if (sortOrder === 'asc') {
      return nameA.localeCompare(nameB);
    } else {
      return nameB.localeCompare(nameA);
    }
  });

  filteredStok.forEach((it, i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td>
      <td>${escapeHtml(it.nama)}</td>
      <td>${formatNumber(it.harga)}</td>
      <td>${it.stok}</td>
      <td>
        <button onclick="hapusItemStok(${i})">Hapus</button>
      </td>`;
    tbody.appendChild(tr);
  });
  setupTransaksiSearch();
  saveStok();
}

function hapusItemStok(i){
  if(!confirm('Hapus barang "'+stok[i].nama+'"?')) return;
  stok.splice(i,1);
  saveStok();
  renderStokTable();
}

/* ===== Transaksi (Searchable Input) ===== */
function setupTransaksiSearch(){
  const searchInput = document.getElementById('transaksiSearchInput');
  const searchResultsDiv = document.getElementById('transaksiSearchResults');
  const selectedItemIndexInput = document.getElementById('transaksiSelectedItemIndex');

  // Clear previous listeners to prevent duplicates
  searchInput.removeEventListener('input', filterTransaksiItems);
  searchInput.removeEventListener('focus', showAllItems);
  searchResultsDiv.removeEventListener('click', selectItem);
  document.removeEventListener('click', hideResults);
  
  searchInput.addEventListener('input', filterTransaksiItems);
  searchInput.addEventListener('focus', showAllItems);
  searchResultsDiv.addEventListener('click', selectItem);
  document.addEventListener('click', hideResults);

  function filterTransaksiItems() {
    const query = searchInput.value.toLowerCase();
    searchResultsDiv.innerHTML = '';
    
    if (query.length > 0) {
      const filtered = stok.filter(item => item.nama.toLowerCase().includes(query));
      if (filtered.length > 0) {
        filtered.forEach(item => {
          const itemIndex = stok.findIndex(i => i.nama === item.nama);
          const div = document.createElement('div');
          div.dataset.index = itemIndex;
          div.textContent = `${item.nama} ‚Äî Rp ${formatNumber(item.harga)} (Stok: ${item.stok})`;
          searchResultsDiv.appendChild(div);
        });
        searchResultsDiv.style.display = 'block';
      } else {
        searchResultsDiv.style.display = 'none';
      }
    } else {
      searchResultsDiv.style.display = 'none';
    }
  }

  function showAllItems() {
    searchResultsDiv.innerHTML = '';
    stok.forEach(item => {
      const itemIndex = stok.findIndex(i => i.nama === item.nama);
      const div = document.createElement('div');
      div.dataset.index = itemIndex;
      div.textContent = `${item.nama} ‚Äî Rp ${formatNumber(item.harga)} (Stok: ${item.stok})`;
      searchResultsDiv.appendChild(div);
    });
    searchResultsDiv.style.display = 'block';
  }

  function selectItem(e) {
    const selectedDiv = e.target.closest('div');
    if (selectedDiv) {
      const index = selectedDiv.dataset.index;
      const item = stok[index];
      searchInput.value = item.nama;
      selectedItemIndexInput.value = index;
      searchResultsDiv.style.display = 'none';
    }
  }

  function hideResults(e) {
    if (!document.getElementById('section-transaksi').contains(e.target)) {
      searchResultsDiv.style.display = 'none';
    }
  }
}

function tambahItemKeKeranjang(){
  const selectedIndex = parseInt(document.getElementById('transaksiSelectedItemIndex').value);
  const jumlah = Math.max(1, parseInt(document.getElementById('transaksiJumlah').value) || 1);
  if(isNaN(selectedIndex) || !stok[selectedIndex]){
    alert('Pilih barang yang valid');
    return;
  }
  const item = stok[selectedIndex];
  if(item.stok < jumlah){
    alert('Stok tidak cukup');
    return;
  }
  
  // deduct stok
  item.stok -= jumlah;
  // if exists in keranjang, add jumlah
  const kidx = keranjang.findIndex(k => k.nama === item.nama);
  if(kidx >= 0){
    keranjang[kidx].jumlah += jumlah;
  } else {
    keranjang.push({ nama: item.nama, harga: item.harga, jumlah });
  }
  saveStok(); saveKeranjang();
  renderStokTable(); renderKeranjangTable();
  document.getElementById('transaksiSearchInput').value = '';
  document.getElementById('transaksiSelectedItemIndex').value = '';
}

/* ===== Keranjang ===== */
function renderKeranjangTable(){
  const tbody = document.querySelector('#keranjangTable tbody');
  tbody.innerHTML = '';
  keranjang.forEach((k, i) => {
    const tr = document.createElement('tr');
    const subtotal = (k.harga * (k.jumlah||0));
    tr.innerHTML = `<td>${escapeHtml(k.nama)}</td>
      <td>${k.jumlah}</td>
      <td>${formatNumber(k.harga)}</td>
      <td>${formatNumber(subtotal)}</td>
      <td><button onclick="hapusDariKeranjang(${i})">Hapus</button></td>`;
    tbody.appendChild(tr);
  });
  hitungRingkasan();
  saveKeranjang();
}

function hapusDariKeranjang(i){
  const item = keranjang[i];
  // Return stok
  const sIdx = stok.findIndex(s => s.nama === item.nama);
  if(sIdx >= 0) stok[sIdx].stok += item.jumlah;
  keranjang.splice(i,1);
  saveStok(); saveKeranjang();
  renderStokTable(); renderKeranjangTable();
}

function kosongkanKeranjang(){
  if(!confirm('Kosongkan keranjang?')) return;
  // return stok
  keranjang.forEach(item => {
    const sIdx = stok.findIndex(s => s.nama === item.nama);
    if(sIdx >= 0) stok[sIdx].stok += item.jumlah;
  });
  keranjang = [];
  saveStok(); saveKeranjang();
  renderKeranjangTable();
  renderStokTable();
}

/* ===== Ringkasan & Cetak ===== */
function hitungRingkasan(){
  const total = keranjang.reduce((sum,k)=>sum + (k.harga*(k.jumlah||0)),0);
  const diskon = parseFloat(document.getElementById('inputDiskon')?.value || 0) || 0;
  const bayar = parseFloat(document.getElementById('inputBayar')?.value || 0) || 0;
  const potongan = total * (Math.max(0,Math.min(100,diskon))/100);
  const totalAkhir = Math.max(0, total - potongan);
  const kembali = bayar - totalAkhir;
  document.getElementById('textTotal').textContent = formatNumber(totalAkhir);
  document.getElementById('textKembali').textContent = formatNumber(Math.max(0, Math.round(kembali)));
  return { total, potongan, totalAkhir, kembali };
}

function cetakStruk(){
  if(keranjang.length === 0){ alert('Keranjang kosong'); return; }
  const data = hitungRingkasan();
  const namaPelanggan = document.getElementById('transaksipelanggan').value || 'Pelanggan Umum';
  const metode = document.getElementById('metodePembayaran').value;
  const waktu = new Date().toLocaleString('id-ID');

  // Add to riwayat before clearing
  riwayat.push({
    pelanggan: namaPelanggan,
    waktu: waktu,
    total: data.totalAkhir,
    metode: metode,
    diskon: parseFloat(document.getElementById('inputDiskon').value || 0),
    bayar: parseFloat(document.getElementById('inputBayar').value || 0),
    kembali: Math.max(0, Math.round(data.kembali)),
    items: JSON.parse(JSON.stringify(keranjang)) // Deep copy
  });
  saveRiwayat();

  // Print struk (same as before)
  let html = `<div style="font-family:monospace;max-width:320px;padding:10px">`;
  html += `<h3 style="text-align:center;margin:6px 0">Bengkel Trisno Motor</h3>`;
  html += `<hr>`;
  html += `<p><b>Pelanggan:</b> ${escapeHtml(namaPelanggan)}</p>`;
  html += `<p><b>Waktu:</b> ${waktu}</p>`;
  html += `<hr>`;
  keranjang.forEach(k=>{
    const line = `${k.nama} x${k.jumlah}`;
    const subtotal = k.harga * k.jumlah;
    html += `<div style="display:flex;justify-content:space-between"><div>${escapeHtml(line)}</div><div>Rp ${formatNumber(subtotal)}</div></div>`;
  });
  html += `<hr>`;
  html += `<div style="display:flex;justify-content:space-between"><div>Total</div><div>Rp ${formatNumber(data.total)}</div></div>`;
  if (data.diskon > 0) {
      html += `<div style="display:flex;justify-content:space-between"><div>Diskon (${data.diskon}%)</div><div>-Rp ${formatNumber(data.potongan)}</div></div>`;
  }
  html += `<div style="display:flex;justify-content:space-between"><div><b>Total Bayar</b></div><div><b>Rp ${formatNumber(data.totalAkhir)}</b></div></div>`;
  html += `<div style="display:flex;justify-content:space-between"><div>Bayar</div><div>Rp ${formatNumber(parseFloat(document.getElementById('inputBayar').value||0))}</div></div>`;
  html += `<div style="display:flex;justify-content:space-between"><div>Kembali</div><div>Rp ${formatNumber(Math.max(0, Math.round(data.kembali)))}</div></div>`;
  html += `<hr><div style="text-align:center">Terima kasih!</div></div>`;
  const w = window.open('','_blank','width=350,height=600');
  w.document.write(html);
  w.document.close();
  w.focus();
  setTimeout(()=>{ w.print(); },300);

  // Clear keranjang and reset inputs
  keranjang = [];
  saveKeranjang();
  renderKeranjangTable();
  renderStokTable();
  document.getElementById('transaksipelanggan').value = '';
  document.getElementById('transaksiSearchInput').value = '';
  document.getElementById('inputDiskon').value = '0';
  document.getElementById('inputBayar').value = '0';
  document.getElementById('metodePembayaran').value = 'Cash';
  renderRiwayatTable();
}

/* ===== Riwayat ===== */
function renderRiwayatTable() {
  const tbody = document.querySelector('#riwayatTable tbody');
  tbody.innerHTML = '';
  riwayat.forEach((r, i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHtml(r.waktu)}</td>
      <td>${escapeHtml(r.pelanggan)}</td>
      <td>Rp ${formatNumber(r.total)}</td>
      <td>${escapeHtml(r.metode)}</td>
      <td>
        <button onclick="lihatRiwayatItem(${i})">Lihat</button>
        <button onclick="hapusRiwayatItem(${i})">Hapus</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
  saveRiwayat();
}

function lihatRiwayatItem(index) {
  const transaction = riwayat[index];
  if (!transaction) return;

  // Populate modal with transaction details
  document.getElementById('modalPelanggan').textContent = transaction.pelanggan;
  document.getElementById('modalTanggal').textContent = transaction.waktu;
  document.getElementById('modalMetode').textContent = transaction.metode;
  document.getElementById('modalTotal').textContent = formatNumber(transaction.total);
  
  const tbody = document.getElementById('modalBarangTableBody');
  tbody.innerHTML = '';
  transaction.items.forEach(item => {
    const tr = document.createElement('tr');
    const subtotal = item.harga * item.jumlah;
    tr.innerHTML = `
      <td>${escapeHtml(item.nama)}</td>
      <td>${item.jumlah}</td>
      <td>${formatNumber(item.harga)}</td>
      <td>${formatNumber(subtotal)}</td>
    `;
    tbody.appendChild(tr);
  });
  
  document.getElementById('riwayatModal').style.display = 'flex';
}

function closeRiwayatModal() {
  document.getElementById('riwayatModal').style.display = 'none';
}

function hapusRiwayatItem(index) {
    if (!confirm('Hapus riwayat transaksi ini?')) return;
    riwayat.splice(index, 1);
    saveRiwayat();
    renderRiwayatTable();
}

/* ===== Helpers ===== */
function formatNumber(n){ if(isNaN(n)) return '0'; return new Intl.NumberFormat('id-ID').format(Math.round(n)); }
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

/* ===== Wire up initial event handlers for buttons that use old names ===== */
document.addEventListener('DOMContentLoaded', ()=> {
  // map buttons that exist in DOM to functions
  // Bind add button created in markup to our function
  // The "Tambah / Update" button in markup calls tambahAtauUpdate(); already mapped to tambahBaru -> which calls tambahBaru -> map to that actual function
  // Ensure elements exist before binding default sections
  if(localStorage.getItem(STORAGE_LOGIN)) {
    document.getElementById('loginPage').style.display = 'none';
    document.getElementById('appMain').style.display = 'block';
    document.getElementById('sidebar').style.display = 'flex';
    initAfterLogin();
  } else {
    document.getElementById('sidebar').style.display = 'none';
  }
  // For convenience, add keyboard handling (Enter) on login box
  const lp = document.getElementById('loginPassword');
  if(lp) lp.addEventListener('keyup', (e)=>{ if(e.key === 'Enter') doLogin(); });
});

/* ===== Expose some functions to console (optional) ===== */
window._debug = { stok, keranjang, riwayat, saveStok, saveKeranjang, saveRiwayat, renderStokTable, renderRiwayatTable };
</script>
</body>
</html>
